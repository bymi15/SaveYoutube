<div class="jumbotron">
    {{#if msg}}
    <div id="message">
        <div style="padding: 5px;">
            <div id="inner-message" class="alert alert-success">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                {{msg}}
            </div>
        </div>
    </div>
    {{/if}}
    <div class="container">
        <h1 style="text-align: center;">{{title}}</h1>
        <div class="form-group">
            <label for="videoURL">Youtube Video or Playlist URL</label>
            <input type="text" class="form-control input-lg" name="videoURL" id="videoURL" placeholder="Paste the URL here...">
            <div id="progress" class="progress progress-striped active hidden">
              <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:100%; line-height: 40px; font-size: 18px;">
                Loading... Please Wait...
              </div>
            </div>
        </div>
        <div style="text-align: center;">
            <button id="mp4Button" type="button" class="btn btn-success">Download as MP4</button>
            <button id="mp3Button" type="button" class="btn btn-info">Download as MP3</button>
            <button id="playlistMP4Button" type="button" class="btn btn-default">Download full playlist (MP4)</button>
            <a class="btn btn-warning" href="/clearUploads">Clear Uploads</a>
        </div>
    </div>
</div>

<div id="playlist" class="container">
    <!-- <div class="playlist-item">
        <div class="media">
            <div class="media-left">
                <a href="#">
                    <img class="media-object" src="http://www.ryanomancefoundation.com/beta/wp-content/uploads/2016/02/video_placeholder.jpg" height="100" alt="...">
                </a>
            </div>
            <div class="media-body">
                <h4 style="color:#000000;" class="media-heading">Media heading</h4>
                <div class="media-buttons">
                    <button class="btn btn-success download-btn" id="#">Download MP4</button>&nbsp
                    <button class="btn btn-primary download-btn" id="#">Download MP3</button>&nbsp
                    <span class="preloader" style="display:none;"><img width="50" src="/images/preloader.gif"></span>
                </div>
            </div>
        </div>
    </div> -->
</div>

<footer class="container">
    <p>Preloader from <a href="https://loading.io/">Loading.io</a></p>
</footer>

<script>
    var showProgress = function(){
        $('#videoURL').addClass('hidden');
        $('#progress').removeClass('hidden');
        $('#mp4Button').attr("disabled", true);
        $('#mp3Button').attr("disabled", true);
        $('#playlistMP4Button').attr("disabled", true);
    }
    var hideProgress = function(){
        $('#videoURL').removeClass('hidden');
        $('#progress').addClass('hidden');
        $('#mp4Button').attr("disabled", false);
        $('#mp3Button').attr("disabled", false);
        $('#playlistMP4Button').attr("disabled", false);
    }

    $("div").on("click", ".download-btn", function(){
        var endpoint = $(this).attr('id');
        var preloader = $(this).parent().find('span');
        var buttonMP4 = $(this).parent().find('.btn-success');
        var buttonMP3 = $(this).parent().find('.btn-primary');
        preloader.show();
        buttonMP4.attr("disabled", true);
        buttonMP3.attr("disabled", true);

        $.ajax({
            type: 'GET',
            url: endpoint,
            success: function(data) {
                preloader.hide();
                buttonMP4.attr("disabled", false);
                buttonMP3.attr("disabled", false);
                window.open(data.file);
            }
        });
    });

    $("#mp4Button").click(function(){
        var youtubeURL = $("#videoURL").val();

        if(youtubeURL.trim() == '') return;

        var data = {youtubeURL: youtubeURL};
        showProgress();

        $.ajax({
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            url: '/mp4',
            success: function(data) {
                if(data.error){
                    alert(data.error);
                }else if(data.playlist){
                    console.log(data.playlist);
                    for(var key in data.playlist){
                        var title = data.playlist[key].title;
                        var thumbnailSrc = data.playlist[key].thumbnails.medium.url;
                        var thumbnailWidth = data.playlist[key].thumbnails.medium.width / 2;
                        var thumbnailHeight = data.playlist[key].thumbnails.medium.height / 2;
                        var vidID = data.playlist[key].resourceId.videoId;

                        var html = '<div class="playlist-item"><div class="media"><div class="media-left"><a href="http://youtube.com/watch?v=' + vidID + '" target="_blank"><img class="media-object" src="' + thumbnailSrc + '" height="' + thumbnailHeight + '" width="' + thumbnailWidth + '"></a></div><div class="media-body"><h4 style="color:#000000;" class="media-heading">' + title + '</h4><div class="media-buttons"><button class="download-btn btn btn-success" id="/mp4/' + vidID + '">Download MP4</button>&nbsp<button class="download-btn btn btn-primary" id="/mp3/' + vidID + '">Download MP3</button>&nbsp<span class="preloader" style="display:none;"><img width="50" src="/images/preloader.gif"></span></div></div></div></div>';
                        $("#playlist").append(html);
                    }
                }else if(data.file){
                    window.open(data.file);
                }
                hideProgress();
            }
        });
    });

    $("#mp3Button").click(function(){
        var youtubeURL = $("#videoURL").val();

        if(youtubeURL.trim() == '') return;

        var data = {youtubeURL: youtubeURL};
        showProgress();

        $.ajax({
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            url: '/mp3',
            success: function(data) {
                if(data.error){
                    alert(data.error);
                }else if(data.playlist){
                    for(var key in data.playlist){
                        var title = data.playlist[key].title;
                        var thumbnailSrc = data.playlist[key].thumbnails.medium.url;
                        var thumbnailWidth = data.playlist[key].thumbnails.medium.width / 2;
                        var thumbnailHeight = data.playlist[key].thumbnails.medium.height / 2;
                        var vidID = data.playlist[key].resourceId.videoId;

                        var html = '<div class="playlist-item"><div class="media"><div class="media-left"><a href="http://youtube.com/watch?v=' + vidID + '" target="_blank"><img class="media-object" src="' + thumbnailSrc + '" height="' + thumbnailHeight + '" width="' + thumbnailWidth + '"></a></div><div class="media-body"><h4 style="color:#000000;" class="media-heading">' + title + '</h4><div class="media-buttons"><button class="download-btn btn btn-success" id="/mp4/' + vidID + '">Download MP4</button>&nbsp<button class="download-btn btn btn-primary" id="/mp3/' + vidID + '">Download MP3</button>&nbsp<span class="preloader" style="display:none;"><img width="50" src="/images/preloader.gif"></span></div></div></div></div>';

                        $("#playlist").append(html);
                    }
                }else if(data.file){
                    window.open(data.file);
                }
                hideProgress();
            }
        });
    });

    $("#playlistMP4Button").click(function(){
        var youtubeURL = $("#videoURL").val();

        if(youtubeURL.trim() == '') return;

        var data = {youtubeURL: youtubeURL};
        showProgress();

        $.ajax({
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            url: '/playlist/mp4',
            success: function(data) {
                if(data.error){
                    alert(data.error);
                }else if(data.playlist){
                    for(var key in data.playlist){
                        var title = data.playlist[key].title;
                        var thumbnailSrc = data.playlist[key].thumbnails.medium.url;
                        var thumbnailWidth = data.playlist[key].thumbnails.medium.width / 2;
                        var thumbnailHeight = data.playlist[key].thumbnails.medium.height / 2;
                        var vidID = data.playlist[key].resourceId.videoId;
                        var fileName = data.playlist[key].fileName;

                        var html = '<div><h4>' + title + '</h4><p><img height="' + thumbnailHeight + '" width="' + thumbnailWidth + '" src="' + thumbnailSrc + '"></p><a class="btn btn-primary" href="/download/' + fileName + '" target="_blank">Download</a></div>'
                        $("#playlist").append(html);
                    }
                }else{
                    alert('An error has occurred. Please try again.');
                }
                hideProgress();
            }
        });
    });
</script>
